jQuery(document).ready(function(e){var t=["toplevel_page_cfm-hosting-publish-episode","admin_page_cfm-hosting-publish-episode","captivate-sync_page_cfm-hosting-publish-episode"];const n=Quill.import("blots/embed");class a extends n{static create(e){const t=super.create(e);return t.setAttribute("data-dt-name",e),t.innerHTML="{{"+e+"}}",t}static value(e){return e.getAttribute("data-dt-name")}}a.blotName="variable",a.tagName="dt-variable",Quill.register("formats/variable",a);const i=Quill.import("blots/block/embed");class o extends i{static create(e){const t=super.create(e);return t.setAttribute("contenteditable",!1),t.setAttribute("data-dt-name","cfm-static-variable-e7ef859fa5c6"),t.innerHTML=e,t}static value(e){return e.innerHTML}}o.blotName="static",o.tagName="dt-static",Quill.register("formats/static",o);var s="",r=e("#cfm-field-wpeditor"),l=document.querySelector("textarea[name=post_content]"),c=!1,d=0;e("#cfm-field-wpeditor").length&&((s=new Quill("#cfm-field-wpeditor",{modules:{toolbar:"#quilljs-toolbar"},placeholder:"Insert text here ...",theme:"snow"})).root.setAttribute("spellcheck",!1),document.querySelector("#cfm-form-publish-episode").onsubmit=function(){var e=r.find(".ql-editor").html();l.value=p(e)},s.on("text-change",function(){var n=r.find(".ql-editor").html();""!=n&&"<p><br></p>"!=n&&(e("#cfm-field-wpeditor").removeClass("invalid-control is-invalid"),e(".cfm-episode-shownotes .ql-toolbar.ql-snow").removeClass("is-invalid"),e("#shownotes-error").remove()),-1!==e.inArray(cfmsync.CFMH_CURRENT_SCREEN,t)&&(localStorage.setItem(cfmsync.CFMH_SHOWID+"_shownotes_local",JSON.stringify(s.getContents())),localStorage.setItem(cfmsync.CFMH_SHOWID+"_shownotes_local_html",p(n))),l.value=p(n),++d>1&&(c=!0)}),e(document).on("mousedown touchstart",function(t){e(t.target).closest(".cfm-captivate-editor").length||c&&e(document).renderVariables()}),e(".cfm-captivate-editor .expand").click(function(){640===e("#cfm-field-wpeditor").height()?(e("#cfm-field-wpeditor").height(340),e(this).html('Expand Writing Area <i class="fa-regular ms-1 fa-expand"></i>')):(e("#cfm-field-wpeditor").height(640),e(this).html('Reduce Writing Area <i class="fa-regular ms-1 fa-arrows-minimize"></i>'))}),-1!==e.inArray(cfmsync.CFMH_CURRENT_SCREEN,t)&&s.setContents(JSON.parse(localStorage.getItem(cfmsync.CFMH_SHOWID+"_shownotes_local"))));function p(e){return output=e,get_all_data_dt_name_value=function(e){for(var t,n=/<dt-variable\s*([^>]*)\s*\/?>/g,a=0,i=new Array;null!==(t=n.exec(e));)i[a]=t[1],a++;return i}(e),get_all_data_dt_name_value.forEach(e=>{const t=e.match(/"(.*?)"/);search=new RegExp("<dt-variable "+e+">(.*?)</dt-variable>","g"),replace="{{"+t[1]+"}}",output=output.replace(search,replace)}),output}s.clipboard.addMatcher("dt-variable",(e,t)=>{const n=Quill.import("delta");let a=t.ops;return(new n).insert("{{"+a[0].insert.variable+"}}")}),e(".dt-show-custom-shortcodes input[type=checkbox]").on("change",function(t){this.checked?e(".dropdown-contents .dropdown-item:not(.dt-custom-shortcode)").hide():e(".dropdown-contents .dropdown-item").show()}),e(document).on("click","#cfm-change-shownotes-template",function(t){t.preventDefault();var n=e(this),a=n.html(),i=n.attr("data-reference");e.ajax({url:cfmsync.ajaxurl,type:"post",data:{action:"change-shownotes-template",show_id:cfmsync.CFMH_SHOWID,template_name:i},beforeSend:function(){n.prop("disabled",!0),n.siblings("button").prop("disabled",!0),n.html('<i class="fas fa-spinner fa-spin me-2"></i> Processing...')},success:function(t){if(n.prop("disabled",!1),n.siblings("button").prop("disabled",!1),n.html(a),e("#confirmation-modal").modal("hide"),"error"==t)cfmsync_toaster("error","Something went wrong! Please contact the support team.");else if(cfmsync_toaster("success","Show Notes Template applied."),e("#enable_wordpress_editor:checked").length==e("#enable_wordpress_editor").length)if(e("#wp-post_content_wp-wrap").hasClass("html-active"))e("#post_content_wp").val(t);else{var i=tinymce.get("post_content_wp");null!==i&&i.setContent(t)}else s.root.innerHTML=t,document.querySelector("textarea[name=post_content]").value=t;e(document).renderVariables()}}),t.preventDefault()}),e(document).on("click","#cfm-insert-dt-block",function(t){t.preventDefault();var n=e(this),a=n.html(),i=n.attr("data-reference"),o=e("input[name=post_id]").val(),r=e("input[name=dt_type]:checked").val(),l=s.selection.savedRange.index;"dynamic"==r?(""==i&&"undefined"==i||(s.insertEmbed(l,"variable",i),e("dt-variable").contents().unwrap(),setTimeout(()=>s.setSelection(l+1,0),0),setTimeout(()=>s.insertText(l+1," "),1)),e("#cfm-insert-block-modal").modal("hide")):e.ajax({url:cfmsync.ajaxurl,type:"post",data:{action:"insert-static-block",show_id:cfmsync.CFMH_SHOWID,post_id:o,data_reference:i},beforeSend:function(){n.prop("disabled",!0),n.siblings("button").prop("disabled",!0),n.html('<i class="fas fa-spinner fa-spin me-2"></i> Processing...')},success:function(t){if(n.prop("disabled",!1),n.siblings("button").prop("disabled",!1),n.html(a),e("#cfm-insert-block-modal").modal("hide"),"error"==t)cfmsync_toaster("error","Something went wrong! Please contact the support team.");else if(t){$e_title=e("input[name=post_title]").val(),$e_number=e("input[name=episode_number]").val(),$e_season=e("input[name=season_number]").val(),$e_type=e("input[name=episode_type]:checked").val(),$e_explicit=e("input[name=episode_explicit]:checked").val(),$episode_title=""!=$e_title?$e_title:"Untitled Episode",t=t.replaceAll("{{d-episode-title}}",$episode_title),$episode_number=""!=$e_number?$e_number:"(No episode number)",t=t.replaceAll("{{d-episode-number}}",$episode_number),$episode_season=""!=$e_season?$e_season:"(Not in a season)",t=(t=t.replaceAll("{{d-episode-season}}",$episode_season)).replaceAll("{{d-episode-type}}",cfm_ucwords($e_type)),$episode_explicit="0"!=$e_explicit?$e_explicit:e("input[name=episode_explicit]:checked").attr("data-explicit-default"),t=t.replaceAll("{{d-episode-explicit}}",cfm_ucwords($episode_explicit));const n=s.getSelection();s.insertEmbed(n.index,"static",t),e("dt-static").contents().unwrap(),s.setSelection(n.index+1)}}}),e(document).renderVariables(),t.preventDefault()}),e(document).on("click","#cfm-insert-dt-shortcode",function(t){t.preventDefault();var n=e(this),a=n.html(),i=n.attr("data-reference"),o=n.attr("data-type"),r=e("input[name=post_id]").val(),l=e("input[name=dt_type]:checked").val(),c=s.selection.savedRange.index;"dynamic"==l?(""==i&&"undefined"==i||(s.insertEmbed(c,"variable",i),e("dt-variable").contents().unwrap(),setTimeout(()=>s.setSelection(c+1,0),0),setTimeout(()=>s.insertText(c+1," "),1)),e("#cfm-insert-shortcode-modal").modal("hide")):e.ajax({url:cfmsync.ajaxurl,type:"post",data:{action:"insert-static-shortcode",show_id:cfmsync.CFMH_SHOWID,post_id:r,data_reference:i,data_type:o},beforeSend:function(){n.prop("disabled",!0),n.siblings("button").prop("disabled",!0),n.html('<i class="fas fa-spinner fa-spin me-2"></i> Processing...')},success:function(t){if(n.prop("disabled",!1),n.siblings("button").prop("disabled",!1),n.html(a),e("#cfm-insert-shortcode-modal").modal("hide"),"error"==t)cfmsync_toaster("error","Something went wrong! Please contact the support team.");else if(t){$e_title=e("input[name=post_title]").val(),$e_number=e("input[name=episode_number]").val(),$e_season=e("input[name=season_number]").val(),$e_type=e("input[name=episode_type]:checked").val(),$e_explicit=e("input[name=episode_explicit]:checked").val(),$episode_title=""!=$e_title?$e_title:"Untitled Episode",t=t.replaceAll("{{d-episode-title}}",$episode_title),$episode_number=""!=$e_number?$e_number:"(No episode number)",t=t.replaceAll("{{d-episode-number}}",$episode_number),$episode_season=""!=$e_season?$e_season:"(Not in a season)",t=(t=t.replaceAll("{{d-episode-season}}",$episode_season)).replaceAll("{{d-episode-type}}",cfm_ucwords($e_type)),$episode_explicit="0"!=$e_explicit?$e_explicit:e("input[name=episode_explicit]:checked").attr("data-explicit-default"),t=t.replaceAll("{{d-episode-explicit}}",cfm_ucwords($episode_explicit));const n=s.getSelection();s.insertEmbed(n.index,"static",t),e("dt-static").contents().unwrap(),s.setSelection(n.index+1)}}}),e(document).renderVariables(),t.preventDefault()}),e(document).on("click","#cfm-dropdown-dt-shortcodes .dt-conditional",function(t){t.preventDefault();var n=e(this).attr("data-reference"),a=s.selection.savedRange.index;s.insertEmbed(a,"variable",n),s.insertEmbed(a+1,"variable","d-condition-end"),e("dt-variable").contents().unwrap(),setTimeout(()=>s.insertText(a+1,"  "),0),setTimeout(()=>s.setSelection(a+2,0),1),e(document).renderVariables(),t.preventDefault()}),e.fn.renderVariables=function(){const t=document.querySelector("textarea[name=post_content]");shownotes=t.value;const n=/{{([^{}]*)}}/g;for(var a;null!==(a=n.exec(shownotes));){/^[A-Za-z0-9]+(?:[_-][A-Za-z0-9]+)*$/g.test(a[1])&&(s.history.ignoreChange=!0,dt='<dt-variable data-dt-name="'+cfm_convert_to_slug(a[1])+'">Loading...</dt-variable>',dt_result=a[1].split("-"),dt_result=dt_result[0]+"-"+dt_result[1],"d-condition"==dt_result&&(dt='<dt-variable data-dt-name="'+cfm_convert_to_slug(a[1])+'" data-conditional-depth="1">Loading...</dt-variable>'),shownotes=shownotes.replace(a[0],dt))}const i=(new DOMParser).parseFromString(shownotes,"text/html"),o=i.querySelectorAll("dt-variable");let r=1;for(let e=0;e<o.length;e++){const t=o[e];-1!==t.getAttribute("data-dt-name").indexOf("d-condition")&&("d-condition-end"===t.getAttribute("data-dt-name")&&r--,t.setAttribute("data-conditional-depth",r),"d-condition-end"!==t.getAttribute("data-dt-name")&&r++,s.history.ignoreChange=!1)}const l=i.body.innerHTML;s.root.innerHTML=l,setTimeout(()=>s.setSelection(s.selection.savedRange.index,0),0),e.ajax({url:cfmsync.ajaxurl,type:"post",data:{action:"render-dt-variables",show_id:cfmsync.CFMH_SHOWID,post_id:e("input[name=post_id]").val(),content:t.value},success:function(t){if("error"==t)cfmsync_toaster("error","Error loading the editor, please refresh the page.");else{var n=JSON.parse(t);e.each(n,function(t,n){s.history.ignoreChange=!1;var a=null!=n&&""!=n?n:"Unrecognized Variable";e("[data-dt-name="+cfm_convert_to_slug(t)+"] span").text(a)})}}}),c=!1},e(document).renderVariables()});